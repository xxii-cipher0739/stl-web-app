<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="https://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<body>
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Requests</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a th:href="@{/requests/add}" class="btn btn-sm btn-success" sec:authorize="hasRole('COLLECTOR') or hasRole('DISPATCHER')">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-plus-square" viewBox="0 0 16 16">
                <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4"/>
            </svg>
            New Request
        </a>
    </div>
</div>

<div class="alert alert-success alert-dismissible fade show" th:if="${successMessage}" role="alert">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-info-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0"/>
    </svg>
    <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
<div class="alert alert-danger alert-dismissible fade show" th:if="${errorMessage}" role="alert">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-circle" viewBox="0 0 16 16">
        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
    </svg>
    <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered table-sm">
        <thead>
        <tr>
            <th scope="col">Reference</th>
            <th scope="col">Date Created</th>
            <th scope="col">Requested By</th>
            <th scope="col">Requested To</th>
            <th scope="col">Amount</th>
            <th scope="col">Status</th>
            <th scope="col">Actions</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="request : ${requests}">
            <td th:text="${request.reference}"></td>
            <td th:text="${#temporals.format(request.dateTimeCreated, 'EEEE, MMMM dd, yyyy hh:mm a')}"></td>
            <td>
                <span th:each="user : ${users}" th:if="${user.id == request.requestedBy}" th:text="${user.name}"></span>
            </td>
            <td>
                <span th:each="user : ${users}" th:if="${user.id == request.requestedTo}" th:text="${user.name}"></span>
            </td>
            <td>
                PHP <span th:text="${request.amount}"></span>
            </td>
            <td>
                <span th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).PENDING}" class="badge bg-primary">Pending</span>
                <span th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).APPROVED}" class="badge bg-success">Approved</span>
                <span th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).REJECTED}" class="badge bg-danger">Rejected</span>
                <span th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).CANCELLED}" class="badge bg-secondary">Cancelled</span>
            </td>
            <td>
                <a th:href="@{/requests/edit/{id}(id=${request.id})}" class="btn btn-sm btn-primary"
                   th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).PENDING && request.requestedBy == currentUserId }">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen" viewBox="0 0 16 16">
                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001m-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708z"/>
                    </svg>
                    Edit
                </a>
                <a th:href="@{/requests/approve/{id}(id=${request.id})}" class="btn btn-sm btn-success"
                   th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).PENDING && request.requestedTo == currentUserId}"
                   onclick="return confirm('Are you sure you want to approve?');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                    </svg>
                    Approve
                </a>
                <a th:href="@{/requests/reject/{id}(id=${request.id})}" class="btn btn-sm btn-danger"
                   th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).PENDING && request.requestedTo == currentUserId}"
                   onclick="return confirm('Are you sure you want to reject?');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                    Reject
                </a>
                <a th:href="@{/requests/cancel/{id}(id=${request.id})}" class="btn btn-sm btn-secondary"
                   th:if="${request.status == T(xyz.playground.stl_web_app.Constants.RequestStatus).PENDING && (request.requestedBy == currentUserId || #authorization.expression('hasRole(''ADMIN'')'))}"
                   onclick="return confirm('Are you sure you want to cancel?');">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-square" viewBox="0 0 16 16">
                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708"/>
                    </svg>
                    Cancel
                </a>
            </td>
        </tr>
        <tr th:if="${#lists.isEmpty(requests)}">
            <td colspan="6" class="text-center">No requests found</td>
        </tr>
        </tbody>
    </table>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Auto-dismiss alerts after 5 seconds (5000 milliseconds)
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(function(alert) {
            setTimeout(function() {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 5000);
        });
    });
</script>
</body>
</html>
